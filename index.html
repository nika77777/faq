<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Энергетический Тэттринг — Навигатор по вопросам</title>
  <meta name="description" content="Интерактивный навигатор по справочнику «Ответы на вопросы» (фиксированные ответы, без генерации новых смыслов)." />

  <style>
    :root {
      color-scheme: light;
      --bg: #ffffff;
      --panel: #f7f7f8;
      --text: #1f2328;
      --muted: #6b7280;
      --border: #e5e7eb;
      --accent: #111827;
      --chip: #ffffff;
      --shadow: 0 8px 24px rgba(0,0,0,0.08);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
      line-height: 1.35;
    }

    .wrap {
      max-width: 1080px;
      margin: 0 auto;
      padding: 18px 16px 40px;
    }

    header {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      justify-content: space-between;
      padding: 12px 12px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, #fff, #fafafa);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .hgroup { flex: 1; min-width: 280px; }
    h1 {
      font-size: 18px;
      margin: 0 0 6px;
      letter-spacing: 0.2px;
    }
    .subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }

    .meta {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
    }

    .badge {
      font-size: 12px;
      color: #111;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      background: #fff;
      white-space: nowrap;
    }

    .row {
      display: grid;
      grid-template-columns: 1.35fr 0.65fr;
      gap: 14px;
      margin-top: 14px;
    }

    @media (max-width: 980px) {
      .row { grid-template-columns: 1fr; }
      .meta { align-items: flex-start; }
      header { flex-direction: column; }
    }

    .panel {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--panel);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .panel-head {
      padding: 12px 12px 10px;
      background: #fff;
      border-bottom: 1px solid var(--border);
    }

    .panel-title {
      font-size: 13px;
      color: var(--muted);
      margin: 0 0 10px;
    }

    .search {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .search input {
      flex: 1;
      min-width: 220px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
      outline: none;
    }
    .search input:focus { border-color: #c7cbd1; }

    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.02s ease, background 0.15s ease;
      user-select: none;
      white-space: nowrap;
    }
    .btn:hover { background: #fbfbfb; }
    .btn:active { transform: translateY(1px); }
    .btn.primary {
      background: #111827;
      border-color: #111827;
      color: #fff;
    }
    .btn.primary:hover { background: #0b1220; }

    .chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .chip {
      border: 1px solid var(--border);
      background: var(--chip);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--text);
      cursor: pointer;
      user-select: none;
    }
    .chip[data-active="true"] {
      border-color: #111827;
      box-shadow: 0 0 0 3px rgba(17,24,39,0.08);
    }

    .chat {
      display: flex;
      flex-direction: column;
      height: 660px;
      background: #fff;
    }

    .chat-log {
      flex: 1;
      overflow: auto;
      padding: 12px;
      background: linear-gradient(180deg, #fff, #fbfbfc);
    }

    .msg {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      align-items: flex-start;
    }
    .bubble {
      max-width: 92%;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      background: #fff;
      box-shadow: 0 6px 16px rgba(0,0,0,0.04);
    }
    .msg.user { justify-content: flex-end; }
    .msg.user .bubble {
      background: #111827;
      color: #fff;
      border-color: #111827;
    }
    .who {
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
    }
    .msg.user .who { color: rgba(255,255,255,0.85); }
    .text { margin: 0; white-space: pre-wrap; }

    .answer-meta {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .pill {
      font-size: 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      background: #fff;
      color: var(--muted);
    }
    .msg.user .pill { display: none; }

    details {
      margin-top: 10px;
      border: 1px dashed #d1d5db;
      border-radius: 12px;
      padding: 10px 10px;
      background: #fcfcfd;
    }
    details summary {
      cursor: pointer;
      color: #111827;
      font-size: 13px;
      user-select: none;
    }

    .chat-foot {
      border-top: 1px solid var(--border);
      background: #fff;
      padding: 10px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .chat-foot input {
      flex: 1;
      min-width: 220px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 14px;
      outline: none;
    }
    .chat-foot input:focus { border-color: #c7cbd1; }

    .right-panel {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .list {
      padding: 10px 12px 12px;
      background: #fff;
    }

    .list h3 {
      font-size: 14px;
      margin: 0 0 10px;
    }

    .qitem {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 10px;
      background: #fff;
      cursor: pointer;
      margin-bottom: 8px;
    }
    .qitem:hover { background: #fbfbfb; }
    .qtitle {
      margin: 0;
      font-size: 13px;
      color: var(--text);
    }
    .qsub {
      margin: 6px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .small {
      font-size: 12px;
      color: var(--muted);
      margin: 0;
    }

    .hr {
      height: 1px;
      background: var(--border);
      margin: 10px 0;
    }

    .kbd {
      font-family: var(--mono);
      font-size: 12px;
      padding: 2px 6px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #fff;
      color: var(--muted);
    }

    .toc {
      max-height: 280px;
      overflow: auto;
      padding-right: 4px;
    }

    .toc a {
      display: block;
      text-decoration: none;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 9px 10px;
      background: #fff;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .toc a:hover { background: #fbfbfb; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="hgroup">
        <h1>Навигатор по «Ответам на вопросы»</h1>
        <p class="subtitle">Формат «чат-навигатор»: фиксированные ответы, без генерации новых смыслов. Цель — быстро найти точный фрагмент справочника и при желании раскрыть «Подробнее».</p>
      </div>
      <div class="meta">
        <div class="badge" id="dataBadge">Данные: загрузка…</div>
        <div class="badge">Режим: навигация</div>
      </div>
    </header>

    <div class="row">
      <section class="panel">
        <div class="panel-head">
          <p class="panel-title">Поиск и фильтры</p>
          <div class="search">
            <input id="globalSearch" type="search" placeholder="Введите ключевые слова, например: «безопасность», «не секта», «границы», «эмпат», «данные», «пауза»" autocomplete="off" />
            <button class="btn" id="clearBtn" type="button">Сбросить</button>
            <button class="btn" id="tocBtn" type="button">Оглавление раздела</button>
            <button class="btn primary" id="helpBtn" type="button">Как пользоваться</button>
          </div>
          <div class="chips" id="categoryChips" aria-label="Категории"></div>
          <p class="small" style="margin-top:10px;">Подсказка: нажмите <span class="kbd">Enter</span> в поле ввода чата, чтобы отправить запрос. Нажмите на вопрос справа, чтобы вставить его в чат.</p>
        </div>

        <div class="chat">
          <div class="chat-log" id="chatLog" aria-live="polite" aria-label="Чат"></div>

          <div class="chat-foot">
            <input id="chatInput" type="text" placeholder="Спросите, например: «Что такое Энергетический Тэттринг на самом деле?»" autocomplete="off" />
            <button class="btn primary" id="sendBtn" type="button">Найти ответ</button>
            <button class="btn" id="suggestBtn" type="button">Подсказать вопросы</button>
          </div>
        </div>
      </section>

      <aside class="right-panel">
        <section class="panel">
          <div class="panel-head">
            <p class="panel-title">Быстрые вопросы</p>
          </div>
          <div class="list">
            <h3 id="quickTitle">Популярное в этой теме</h3>
            <div id="quickList"></div>
            <div class="hr"></div>
            <p class="small">Здесь показываются вопросы, которые лучше всего совпадают с выбранной категорией и текущим поиском.</p>
          </div>
        </section>

        <section class="panel">
          <div class="panel-head">
            <p class="panel-title">Оглавление выбранного раздела</p>
          </div>
          <div class="list">
            <p class="small" id="tocHint">Выберите категорию и нажмите «Оглавление раздела».</p>
            <div class="toc" id="tocList" style="display:none;"></div>
          </div>
        </section>

        <section class="panel">
          <div class="panel-head">
            <p class="panel-title">Границы и безопасность</p>
          </div>
          <div class="list">
            <p class="small">
              Этот навигатор не заменяет врача или психотерапию и не предназначен для кризисных ситуаций.
              Если вам плохо, тревожно, нестабильно, нарушается сон, нарастает страх или теряется контакт с реальностью, остановите любые практики и обратитесь за профессиональной помощью.
            </p>
            <div class="hr"></div>
            <p class="small">
              При необходимости вы можете добавить на сайт отдельную ссылку «Контакт для поддержки» под чатом, без давления и без обещаний.
            </p>
          </div>
        </section>
      </aside>
    </div>
  </div>

  <script type="module">
    "use strict";

    /*
      ДАННЫЕ
      ВАЖНО: faq-data.js должен лежать рядом с index.html в том же каталоге репозитория.
    */
    import { FAQ } from "./faq-data.js";

    const CATEGORIES = [...new Set(FAQ.map(x => x.category))];

    const state = {
      activeCategory: "Все категории",
      search: "",
      lastSuggestions: [],
      tocVisible: false
    };

    const el = (id) => document.getElementById(id);

    function normalize(s) {
      return (s || "")
        .toLowerCase()
        .replace(/ё/g, "е")
        .replace(/[^\p{L}\p{N}\s\-]+/gu, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function scoreMatch(item, query) {
      const q = normalize(query);
      if (!q) return 0;

      const hay = [
        item.question,
        item.short,
        item.answer_main,
        item.answer_more || "",
        item.category,
        (item.tags || []).join(" ")
      ].map(normalize).join(" | ");

      let score = 0;
      const parts = q.split(" ").filter(Boolean);

      for (const p of parts) {
        if (hay.includes(p)) score += 10;
      }

      if (normalize(item.question).includes(q)) score += 25;
      if ((item.tags || []).map(normalize).join(" ").includes(q)) score += 15;
      if (normalize(item.category).includes(q)) score += 8;

      return score;
    }

    function filterFAQ() {
      const query = state.search;
      const cat = state.activeCategory;

      let items = FAQ.slice();

      if (cat !== "Все категории") {
        items = items.filter(x => x.category === cat);
      }

      if (query) {
        items = items
          .map(x => ({ x, score: scoreMatch(x, query) }))
          .filter(o => o.score > 0)
          .sort((a, b) => b.score - a.score)
          .map(o => o.x);
      }

      return items;
    }

    function setCategories() {
      const wrap = el("categoryChips");
      wrap.innerHTML = "";

      const all = document.createElement("div");
      all.className = "chip";
      all.textContent = "Все категории";
      all.dataset.active = (state.activeCategory === "Все категории") ? "true" : "false";
      all.addEventListener("click", () => {
        state.activeCategory = "Все категории";
        state.tocVisible = false;
        render();
      });
      wrap.appendChild(all);

      for (const c of CATEGORIES) {
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = c;
        chip.dataset.active = (state.activeCategory === c) ? "true" : "false";
        chip.addEventListener("click", () => {
          state.activeCategory = c;
          state.tocVisible = false;
          render();
        });
        wrap.appendChild(chip);
      }
    }

    function appendMsg({ who, text, isUser, meta }) {
      const log = el("chatLog");

      const msg = document.createElement("div");
      msg.className = "msg" + (isUser ? " user" : "");

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      const whoP = document.createElement("p");
      whoP.className = "who";
      whoP.textContent = who;

      const textP = document.createElement("p");
      textP.className = "text";
      textP.textContent = text;

      bubble.appendChild(whoP);
      bubble.appendChild(textP);

      if (meta && !isUser) {
        const metaWrap = document.createElement("div");
        metaWrap.className = "answer-meta";

        const pill1 = document.createElement("span");
        pill1.className = "pill";
        pill1.textContent = meta.category || "";

        const pill2 = document.createElement("span");
        pill2.className = "pill";
        pill2.textContent = meta.source || "";

        metaWrap.appendChild(pill1);
        metaWrap.appendChild(pill2);
        bubble.appendChild(metaWrap);

        if (meta.more) {
          const det = document.createElement("details");
          const sum = document.createElement("summary");
          sum.textContent = "Подробнее";
          const moreP = document.createElement("p");
          moreP.className = "text";
          moreP.style.marginTop = "10px";
          moreP.textContent = meta.more;
          det.appendChild(sum);
          det.appendChild(moreP);
          bubble.appendChild(det);
        }
      }

      msg.appendChild(bubble);
      log.appendChild(msg);

      requestAnimationFrame(() => {
        log.scrollTop = log.scrollHeight;
      });
    }

    function bestAnswer(query) {
      const q = normalize(query);
      if (!q) return null;

      const items = FAQ
        .map(x => ({ x, score: scoreMatch(x, q) }))
        .sort((a, b) => b.score - a.score);

      if (!items.length || items[0].score <= 0) return null;

      const top = items[0].x;
      const strongEnough = items[0].score >= 20 || (normalize(top.question).includes(q) && q.length >= 6);
      if (!strongEnough) return null;

      return top;
    }

    function buildSuggestions() {
      const candidates = filterFAQ();
      const pool = candidates.length ? candidates : FAQ.slice();

      const picked = [];
      const seen = new Set();

      const query = normalize(state.search);

      if (query) {
        const ranked = FAQ
          .map(x => ({ x, score: scoreMatch(x, query) }))
          .sort((a, b) => b.score - a.score)
          .map(o => o.x);

        for (const it of ranked) {
          if (picked.length >= 6) break;
          if (seen.has(it.id)) continue;
          picked.push(it);
          seen.add(it.id);
        }
      }

      if (state.activeCategory !== "Все категории") {
        for (const it of FAQ.filter(x => x.category === state.activeCategory)) {
          if (picked.length >= 6) break;
          if (seen.has(it.id)) continue;
          picked.push(it);
          seen.add(it.id);
        }
      }

      for (const it of pool) {
        if (picked.length >= 6) break;
        if (seen.has(it.id)) continue;
        picked.push(it);
        seen.add(it.id);
      }

      state.lastSuggestions = picked;
      return picked;
    }

    function renderQuickList() {
      const list = el("quickList");
      list.innerHTML = "";

      const items = buildSuggestions();

      const title = el("quickTitle");
      if (state.activeCategory === "Все категории") {
        title.textContent = state.search ? "Подходящие вопросы" : "Популярные вопросы";
      } else {
        title.textContent = "Популярное в теме: " + state.activeCategory;
      }

      for (const it of items) {
        const card = document.createElement("div");
        card.className = "qitem";
        card.setAttribute("role", "button");
        card.tabIndex = 0;

        const p1 = document.createElement("p");
        p1.className = "qtitle";
        p1.textContent = it.question;

        const p2 = document.createElement("p");
        p2.className = "qsub";
        p2.textContent = it.short;

        card.appendChild(p1);
        card.appendChild(p2);

        const putToInput = () => {
          el("chatInput").value = it.question;
          el("chatInput").focus();
        };

        card.addEventListener("click", putToInput);
        card.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            putToInput();
          }
        });

        list.appendChild(card);
      }
    }

    function renderTOC() {
      const tocWrap = el("tocList");
      const hint = el("tocHint");

      if (!state.tocVisible) {
        tocWrap.style.display = "none";
        tocWrap.innerHTML = "";
        hint.textContent = "Выберите категорию и нажмите «Оглавление раздела».";
        return;
      }

      if (state.activeCategory === "Все категории") {
        tocWrap.style.display = "none";
        tocWrap.innerHTML = "";
        hint.textContent = "Оглавление доступно только после выбора конкретной категории.";
        return;
      }

      const items = FAQ.filter(x => x.category === state.activeCategory);

      tocWrap.innerHTML = "";
      for (const it of items) {
        const a = document.createElement("a");
        a.href = "#";
        a.textContent = it.question;
        a.addEventListener("click", (e) => {
          e.preventDefault();
          el("chatInput").value = it.question;
          el("chatInput").focus();
        });
        tocWrap.appendChild(a);
      }

      hint.textContent = "Нажмите на вопрос, чтобы вставить его в поле ввода чата.";
      tocWrap.style.display = "block";
    }

    function render() {
      setCategories();
      renderQuickList();
      renderTOC();
    }

    function showHelp() {
      appendMsg({
        who: "Навигатор",
        text:
          "Как пользоваться:\n" +
          "1) Выберите категорию или оставьте «Все категории».\n" +
          "2) Введите ключевые слова в поле поиска сверху, чтобы сузить список.\n" +
          "3) Нажмите на вопрос справа или в оглавлении раздела, чтобы вставить его в чат.\n" +
          "4) Введите свой вопрос внизу и нажмите «Найти ответ».\n\n" +
          "Важно:\n" +
          "— Навигатор выдаёт только заранее внесённые фрагменты.\n" +
          "— Он не интерпретирует, не диагностирует и не заменяет профессиональную помощь.",
        isUser: false,
        meta: { category: "Справка", source: "Локальная подсказка" }
      });
    }

    function handleAsk(raw) {
      const q = (raw || "").trim();
      if (!q) return;

      appendMsg({ who: "Вы", text: q, isUser: true });

      const ans = bestAnswer(q);

      if (!ans) {
        appendMsg({
          who: "Навигатор",
          text:
            "Я не нашёл точного совпадения в текущей базе вопросов.\n" +
            "Попробуйте:\n" +
            "— переформулировать вопрос проще;\n" +
            "— использовать 2–4 ключевых слова;\n" +
            "— выбрать категорию сверху.\n\n" +
            "Если вы хотите, я могу показать список подсказок вопросов.",
          isUser: false,
          meta: { category: "Навигация", source: "Совпадение не найдено" }
        });
        return;
      }

      appendMsg({
        who: "Навигатор",
        text: ans.answer_main,
        isUser: false,
        meta: {
          category: ans.category,
          source: ans.source_hint,
          more: ans.answer_more || ""
        }
      });
    }

    function suggestInChat() {
      const items = buildSuggestions();
      const lines = items.map((x, i) => `${i + 1}) ${x.question}`).join("\n");
      appendMsg({
        who: "Навигатор",
        text:
          "Вот несколько вопросов, с которых можно начать:\n" +
          lines + "\n\n" +
          "Выберите один и вставьте его в поле ввода, либо нажмите на вопрос справа.",
        isUser: false,
        meta: { category: "Подсказки", source: "Список вопросов" }
      });
    }

    function resetAll() {
      state.activeCategory = "Все категории";
      state.search = "";
      state.tocVisible = false;

      el("globalSearch").value = "";
      el("tocList").innerHTML = "";
      el("tocList").style.display = "none";

      render();
      appendMsg({
        who: "Навигатор",
        text: "Сброс выполнен. Вы можете начать заново: выбрать категорию, ввести ключевые слова или сразу задать вопрос.",
        isUser: false,
        meta: { category: "Навигация", source: "Сброс" }
      });
    }

    function init() {
      el("dataBadge").textContent = `Данные: ${FAQ.length} вопросов`;

      render();

      appendMsg({
        who: "Навигатор",
        text:
          "Здравствуйте. Я помогу найти нужный ответ в справочнике.\n" +
          "Вы можете:\n" +
          "— выбрать категорию сверху;\n" +
          "— нажать на готовый вопрос справа;\n" +
          "— открыть «Оглавление раздела» для полного списка вопросов;\n" +
          "— или написать свой вопрос внизу.",
        isUser: false,
        meta: { category: "Старт", source: "Локальный навигатор" }
      });

      // Debounce для поиска, чтобы не перерисовывать на каждый символ слишком часто
      let t = null;
      el("globalSearch").addEventListener("input", (e) => {
        const v = e.target.value || "";
        clearTimeout(t);
        t = setTimeout(() => {
          state.search = v;
          render();
        }, 80);
      });

      el("sendBtn").addEventListener("click", () => {
        const input = el("chatInput");
        const v = input.value;
        input.value = "";
        handleAsk(v);
      });

      el("chatInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          el("sendBtn").click();
        }
      });

      el("suggestBtn").addEventListener("click", () => suggestInChat());
      el("helpBtn").addEventListener("click", () => showHelp());
      el("clearBtn").addEventListener("click", () => resetAll());

      el("tocBtn").addEventListener("click", () => {
        state.tocVisible = !state.tocVisible;
        renderTOC();
      });
    }

    init();
  </script>
</body>
</html>
