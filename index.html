<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ответы на вопросы — Энергетический Тэттринг</title>
  <meta name="description" content="Часто задаваемые вопросы об Энергетическом Тэттринге. Выберите раздел, откройте вопрос первого уровня, при необходимости раскройте «Подробнее» и получите доступ ко второму уровню." />

  <style>
    :root{
      color-scheme: light;

      /* Kadence-логика из ваших настроек */
      --base: 17px;
      --h1: 32px;
      --h2: 28px;
      --w700: 700;

      /* Похоже на ваш сайт: тёмно-синий + золото */
      --navy-1:#071a33;
      --navy-2:#0b2a52;
      --gold:#b68b2a;

      --text:#0b1220;
      --muted:#5b6778;

      --bg:#ffffff;
      --surface:#ffffff;
      --surface-2:#f7f7f8;
      --border: rgba(16, 24, 40, 0.12);
      --shadow: 0 12px 28px rgba(2, 6, 23, 0.12);

      --r-lg: 18px;
      --r-md: 14px;

      --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    }

    *{ box-sizing: border-box; }

    body{
      margin:0;
      font-family: var(--font);
      font-size: var(--base);
      color: var(--text);
      background: var(--bg);
      line-height: 1.6;
    }

    .hero{
      background: radial-gradient(1200px 600px at 20% 20%, rgba(255,255,255,0.08), transparent 55%),
                  radial-gradient(800px 500px at 80% 10%, rgba(182,139,42,0.18), transparent 55%),
                  linear-gradient(180deg, var(--navy-1), var(--navy-2));
      color:#fff;
      padding: 34px 16px 22px;
    }

    .wrap{
      max-width: 1020px;
      margin: 0 auto;
      padding: 0 16px;
    }

    .hero h1{
      margin:0;
      font-size: var(--h1);
      font-weight: var(--w700);
      line-height: 1.1;
      letter-spacing: 0.2px;
    }

    .hero p{
      margin: 12px 0 0;
      max-width: 920px;
      color: rgba(255,255,255,0.88);
    }

    .content{
      padding: 18px 16px 56px;
    }

    /* Tabs */
    .tabs{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 0 0 14px;
    }

    .tab{
      appearance:none;
      border: 1px solid rgba(182,139,42,0.55);
      background: #fff;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      font-weight: var(--w700);
      line-height: 1.2;
      transition: background 120ms ease, transform 20ms ease, border-color 120ms ease;
    }

    .tab:hover{ background: rgba(182,139,42,0.06); }
    .tab:active{ transform: translateY(1px); }
    .tab[aria-selected="true"]{
      background: var(--gold);
      border-color: var(--gold);
      color: #fff;
    }

    .panel{
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      background: var(--surface);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .panel-head{
      padding: 18px 18px 14px;
      background: linear-gradient(180deg, #ffffff, #fbfbfc);
      border-bottom: 1px solid var(--border);
    }

    .panel-title{
      margin: 0;
      font-size: var(--h2);
      font-weight: var(--w700);
      line-height: 1.18;
    }

    .panel-sub{
      margin: 10px 0 0;
      color: var(--muted);
    }

    .block{
      padding: 16px 18px 10px;
    }

    .block h3{
      margin: 0 0 10px;
      font-size: 16px;
      font-weight: var(--w700);
      color: #182235;
      letter-spacing: 0.2px;
    }

    details.qa{
      margin: 0 0 10px;
      border: 1px solid var(--border);
      border-radius: var(--r-md);
      background: #fff;
      overflow: hidden;
    }

    details.qa summary{
      list-style: none;
      cursor: pointer;
      padding: 14px 14px;
      font-size: 18px;
      font-weight: var(--w700);
      line-height: 1.25;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      user-select: none;
    }

    details.qa summary::-webkit-details-marker{ display:none; }

    .chev{
      width: 30px;
      height: 30px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      border: 1px solid var(--border);
      background: var(--surface-2);
      flex: 0 0 auto;
    }

    .chev svg{ transition: transform 160ms ease; }
    details.qa[open] .chev svg{ transform: rotate(180deg); }

    .qa-body{
      border-top: 1px solid var(--border);
      padding: 14px 14px 14px; /* ВАЖНО: добавили общий отступ, чтобы текст не лип к рамке */
    }

    /* Форматирование ответов */
    .answer, .more-body{
      font-size: var(--base);
      color: var(--text);
    }

    .answer p, .more-body p{
      margin: 0 0 14px;
    }

    .answer p:last-child, .more-body p:last-child{
      margin-bottom: 0;
    }

    .answer ul, .more-body ul{
      margin: 12px 0 14px 22px;
      padding: 0;
    }

    .answer li, .more-body li{
      margin: 7px 0;
    }

    /* Визуальные "якоря внимания" (не меняют текст) */
    .answer mark, .more-body mark{
      background: rgba(182,139,42,0.18);
      padding: 0 3px;
      border-radius: 6px;
    }

    .answer strong.lead, .more-body strong.lead{
      font-weight: var(--w700);
    }

    /* Подробнее */
    .more-wrap{
      margin-top: 14px;
      border: 1px dashed rgba(182,139,42,0.55);
      border-radius: 14px;
      background: rgba(182,139,42,0.06);
      overflow: hidden;
      padding-top: 6px;
    }

    details.more summary{
      cursor: pointer;
      padding: 10px 12px 12px;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    details.more summary::-webkit-details-marker{ display:none; }

    details.more summary::before{
      content: "Подробнее";
      background: var(--gold);
      color: #fff;
      font-weight: var(--w700);
      padding: 8px 12px;
      border-radius: 12px;
      display: inline-block;
    }

    .more-body{
      padding: 0 12px 12px;
    }

    /* Второй уровень: появляется только после раскрытия "Подробнее" */
    .level2{
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px solid rgba(16,24,40,0.10);
    }

    .level2 h4{
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: var(--w700);
      color: #182235;
    }

    .level2.is-hidden{
      display: none;
    }

    .note{
      margin-top: 20px;
      padding: 18px 18px;
      border-radius: var(--r-lg);
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: var(--shadow);
    }

    .note h2{
      margin: 0;
      font-size: 18px;
      font-weight: var(--w700);
    }

    .note p{
      margin: 10px 0 0;
      color: var(--muted);
    }

    @media (max-width: 520px){
      details.qa summary{ font-size: 17px; }
      .tab{ width: 100%; text-align: left; }
    }
  </style>
</head>

<body>
  <header class="hero">
    <div class="wrap">
      <h1>Ответы на вопросы</h1>
      <p>Это вопросы, которые чаще всего возникают при знакомстве с Энергетическим Тэттрингом. Выберите раздел, откройте вопрос первого уровня, а если у вопроса есть «Подробнее», вы увидите углубление и список вопросов второго уровня.</p>
    </div>
  </header>

  <main class="content">
    <div class="wrap">
      <div class="tabs" id="tabs" role="tablist" aria-label="Разделы"></div>

      <section class="panel" aria-live="polite">
        <div class="panel-head">
          <h2 class="panel-title" id="panelTitle"></h2>
          <p class="panel-sub" id="panelSub"></p>
        </div>

        <div class="block">
          <h3>Часто задаваемые вопросы</h3>
          <div id="level1List"></div>
        </div>
      </section>

      <section class="note">
        <h2>Границы и безопасность</h2>
        <p>Этот справочник не заменяет врача или психотерапию и не предназначен для кризисных ситуаций. Если вам плохо, тревожно, нестабильно, нарушается сон, нарастает страх или теряется контакт с реальностью, остановите любые практики и обратитесь за профессиональной помощью.</p>
      </section>
    </div>
  </main>

  <script type="module">
    "use strict";
    import { FAQ } from "./faq-data.js";

    const SECTIONS = [
      "Что это за система и можно ли ей доверять",
      "Безопасность, границы и когда становится хуже",
      "Как это устроено на практике",
      "Что это даёт и чего не стоит ожидать",
      "Необычный опыт, инсайты и рациональный взгляд",
      "Для профессионалов и тех, кто уже многое пробовал"
    ];

    const panelTitle = document.getElementById("panelTitle");
    const panelSub = document.getElementById("panelSub");
    const tabs = document.getElementById("tabs");
    const level1List = document.getElementById("level1List");

    function sectionIntro(title){
      const map = {
        "Что это за система и можно ли ей доверять": "Про ядро, границы, доверие, деньги и прозрачность.",
        "Безопасность, границы и когда становится хуже": "Про риски, перегруз, противопоказания и протоколы паузы.",
        "Как это устроено на практике": "Про форматы участия, выборочность, данные и выход/возврат.",
        "Что это даёт и чего не стоит ожидать": "Про ожидания, реальные изменения и критерии «это работает».",
        "Необычный опыт, инсайты и рациональный взгляд": "Про инсайты, символический язык и трезвость без мистификации.",
        "Для профессионалов и тех, кто уже многое пробовал": "Про этику, позиционирование, риски и интеграцию в практику."
      };
      return map[title] || "";
    }

    function parseQno(sourceHint){
      const m = String(sourceHint || "").match(/вопрос:\s*(\d+)/i);
      return m ? Number(m[1]) : null;
    }

    function groupFor(category, qno){
      const sec = category;

      if (sec === "Что это за система и можно ли ей доверять") {
        if (qno >= 1 && qno <= 3) return "L1_ONE";
        if (qno >= 4 && qno <= 8) return "L1_TWO";
        if (qno >= 9 && qno <= 13) return "L2";
      }

      if (sec === "Безопасность, границы и когда становится хуже") {
        if (qno >= 1 && qno <= 3) return "L1_ONE";
        if (qno >= 4 && qno <= 9) return "L1_TWO";
        if (qno >= 10 && qno <= 14) return "L2";
      }

      if (sec === "Как это устроено на практике") {
        if (qno >= 1 && qno <= 5) return "L1_ONE";
        if (qno >= 6 && qno <= 7) return "L1_TWO";
        if (qno >= 8 && qno <= 11) return "L2";
      }

      if (sec === "Что это даёт и чего не стоит ожидать") {
        if (qno >= 1 && qno <= 4) return "L1_ONE";
        if (qno >= 5 && qno <= 8) return "L1_TWO";
        if (qno >= 9 && qno <= 13) return "L2";
      }

      if (sec === "Необычный опыт, инсайты и рациональный взгляд") {
        if (qno >= 1 && qno <= 4) return "L1_ONE";
        if (qno >= 5 && qno <= 7) return "L1_TWO";
        if (qno >= 8 && qno <= 12) return "L2";
      }

      if (sec === "Для профессионалов и тех, кто уже многое пробовал") {
        if (qno >= 1 && qno <= 5) return "L1_ONE";
        if (qno >= 6 && qno <= 11) return "L1_TWO";
        if (qno >= 12 && qno <= 16) return "L2";
      }

      return "UNK";
    }

    function normalizeData(){
      return FAQ.map((x, idx) => {
        const qno = parseQno(x.source_hint);
        const g = groupFor(x.category, qno);
        return { ...x, qno, g, order: idx + 1 };
      });
    }

    function sortByQno(a,b){
      return (a.qno ?? 1e9) - (b.qno ?? 1e9);
    }

    function chevron(){
      const span = document.createElement("span");
      span.className = "chev";
      span.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
      return span;
    }

    function cleanOddSymbols(t){
      // Убираем "псевдо-иконки" и мусорные спецсимволы, которые иногда прилипают из PDF.
      // Важно: не трогаем буквы/цифры/пунктуацию, только явные знаки форматирования.
      return String(t || "")
        .replace(/[▌▍▎▏■□▪▫●◦◆◇▶▷►▻◀◁◄◅★☆✦✧✱✳︎✴︎☰☷☵☳☲☱☰]/g, "")
        .replace(/\uFFFC/g, "")  // object replacement character
        .replace(/\u200B/g, "")  // zero width space
        .replace(/\u2060/g, "")  // word joiner
        .replace(/\u00A0/g, " "); // non-breaking space -> обычный пробел
    }

    function cleanAnswerText(raw){
      let t = cleanOddSymbols(raw);

      // Убираем строки вида "Ответы на вопросы 16"
      t = t.replace(/^\s*Ответы на вопросы\s+\d+\s*$/gmi, "");

      // Убираем случайно попавшую строку "Второй уровень — углубление"
      t = t.replace(/^\s*Второй уровень\s*—\s*углубление\s*$/gmi, "");

      // Схлопываем лишние пустые строки
      t = t.replace(/\n{3,}/g, "\n\n");

      return t.trim();
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function applyFocusHighlights(plainText){
      // Визуальные якоря без изменения слов: подсветим только очевидные маркеры.
      // 1) "Первое/Второе/..." в тексте (не только в начале) — если встречается как отдельное слово
      // 2) Пары "важно", "главный принцип", "первое —", "второе —" и т.п. не меняя смысл
      let s = escapeHtml(plainText);

      const patterns = [
        /\bПервое\b/g,
        /\bВторое\b/g,
        /\bТретье\b/g,
        /\bЧетвёртое\b/g,
        /\bВажно\b/g,
        /\bГлавный принцип\b/g,
        /\bКлючевые принципы\b/g
      ];

      for(const p of patterns){
        s = s.replace(p, (m) => `<mark>${m}</mark>`);
      }

      return s;
    }

    function renderAnswer(container, rawText){
      const text = cleanAnswerText(rawText);
      container.innerHTML = "";
      if(!text){
        return;
      }

      const blocks = text.split(/\n\s*\n/).map(x => x.trim()).filter(Boolean);

      for(const block of blocks){
        const lines = block.split("\n").map(x => x.trim()).filter(Boolean);
        const isList = lines.length >= 2 && lines.every(l => /^([—\-•])\s+/.test(l));

        if(isList){
          const ul = document.createElement("ul");
          for(const l of lines){
            const li = document.createElement("li");
            li.textContent = l.replace(/^([—\-•])\s+/, "");
            ul.appendChild(li);
          }
          container.appendChild(ul);
          continue;
        }

        // обычный абзац (склеиваем переносы строк внутри блока)
        const pText = lines.join(" ");

        const p = document.createElement("p");
        // Локальная подсветка (mark) — визуально, без изменения слов
        p.innerHTML = applyFocusHighlights(pText);
        container.appendChild(p);
      }
    }

    function makeQA(item){
      const d = document.createElement("details");
      d.className = "qa";

      const s = document.createElement("summary");
      s.appendChild(document.createTextNode(cleanOddSymbols(item.question)));
      s.appendChild(chevron());
      d.appendChild(s);

      const body = document.createElement("div");
      body.className = "qa-body";

      const ans = document.createElement("div");
      ans.className = "answer";
      renderAnswer(ans, item.answer_main || "");
      body.appendChild(ans);

      d.appendChild(body);
      return { d, body };
    }

    function renderSection(sectionTitle){
      panelTitle.textContent = sectionTitle;
      panelSub.textContent = sectionIntro(sectionTitle);
      level1List.innerHTML = "";

      const data = normalizeData().filter(x => x.category === sectionTitle);

      const l1_one = data.filter(x => x.g === "L1_ONE").sort(sortByQno);
      const l1_two = data.filter(x => x.g === "L1_TWO").sort(sortByQno);
      const l2 = data.filter(x => x.g === "L2").sort(sortByQno);

      const allL1 = [...l1_one, ...l1_two].sort(sortByQno);

      for(const item of allL1){
        const { d, body } = makeQA(item);

        const hasMore = item.answer_more && String(item.answer_more).trim().length > 0;

        if(hasMore){
          const moreWrap = document.createElement("div");
          moreWrap.className = "more-wrap";

          const more = document.createElement("details");
          more.className = "more";

          const ms = document.createElement("summary");
          ms.appendChild(document.createTextNode(" "));
          more.appendChild(ms);

          const mb = document.createElement("div");
          mb.className = "more-body";
          renderAnswer(mb, item.answer_more || "");
          more.appendChild(mb);

          moreWrap.appendChild(more);
          body.appendChild(moreWrap);

          const level2Wrap = document.createElement("div");
          level2Wrap.className = "level2 is-hidden";

          const h4 = document.createElement("h4");
          h4.textContent = "Вопросы для углубления";
          level2Wrap.appendChild(h4);

          for(const q of l2){
            const qNode = makeQA(q).d;
            level2Wrap.appendChild(qNode);
          }

          body.appendChild(level2Wrap);

          // УБРАЛИ автоскролл: просто показываем/скрываем второй уровень.
          more.addEventListener("toggle", () => {
            if(more.open){
              level2Wrap.classList.remove("is-hidden");
            } else {
              level2Wrap.classList.add("is-hidden");
            }
          });
        }

        level1List.appendChild(d);
      }
    }

    function renderTabs(){
      tabs.innerHTML = "";

      for(const title of SECTIONS){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "tab";
        btn.setAttribute("role", "tab");
        btn.setAttribute("aria-selected", "false");
        btn.textContent = title;

        btn.addEventListener("click", () => {
          for(const b of tabs.querySelectorAll(".tab")){
            b.setAttribute("aria-selected", "false");
          }
          btn.setAttribute("aria-selected", "true");
          renderSection(title);
          window.scrollTo({ top: 0, behavior: "smooth" });
        });

        tabs.appendChild(btn);
      }

      const first = tabs.querySelector(".tab");
      if(first){
        first.setAttribute("aria-selected", "true");
        renderSection(first.textContent);
      }
    }

    renderTabs();
  </script>
</body>
</html>
